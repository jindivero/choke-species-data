dat_phys$date <- NULL
dat_phys <- as.data.frame(dat_phys)
missing <- subset(dat_phys, is.na(dat$temp_glorys))
missing <- subset(dat_phys, is.na(dat_phys$temp_glorys))
View(missing)
View(dat_phys)
View(missing)
View(o2_ak)
gc()
setwd("~/Dropbox/choke species/code/choke-species-data/code/wa_state")
source("/Users/jindiv/Library/CloudStorage/Dropbox/choke species/code/choke-species-data/code/wa_state/util_funs.R")
#Load all glorys datasets
o2_ak <- readRDS("~/Dropbox/choke species/code/choke-species-data/data/glorys/glorys_hauls/glorys_o2_AKnew.rds")
o2_bc <- readRDS("~/Dropbox/choke species/code/choke-species-data/data/glorys/glorys_hauls/glorys_o2_BC.rds")
o2_wc <- readRDS("~/Dropbox/choke species/code/choke-species-data/data/glorys/glorys_hauls/glorys_o2_WC.rds")
ts_ak <- readRDS("~/Dropbox/choke species/code/choke-species-data/data/glorys/glorys_hauls/glorys_tempsal_AKnew.rds")
ts_bc <- readRDS("~/Dropbox/choke species/code/choke-species-data/data/glorys/glorys_hauls/glorys_tempsal_BC.rds")
ts_wc <- readRDS("~/Dropbox/choke species/code/choke-species-data/data/glorys/glorys_hauls/glorys_tempsal_WC.rds")
#Add BC October data where missing
bc_oct_o2 <-  readRDS("~/Dropbox/choke species/code/choke-species-data/data/glorys/glorys_hauls/glorys_o2_bc3_full_region_bottom_octdates.rds")
##Temp and sal
#Clean up
ts_ak$event_id <- ts_ak$hauljoin
ts_ak$date_glorysphys <- as.character(ts_ak$date_glorysphys)
ts_ak$hauljoin <- NULL
ts_wc <- ts_wc[,c(1:8,12:13,16,20:28)]
ts_bc <- ts_bc[,c(1:8, 12:13, 16, 20:27)]
#Combine
dat_phys <- bind_rows(ts_ak, ts_bc, ts_wc)
#Clean up more
dat_phys$year <- NULL
dat_phys$date_haul <- dat_phys$date2
dat_phys$date2 <- NULL
dat_phys$date <- NULL
dat_phys <- as.data.frame(dat_phys)
missing <- subset(dat_phys, is.na(dat_phys$temp_glorys))
View(missing)
View(missing)
missing <- subset(missing, date_glorysphys<as.POSIXct("2021-06-30")
missing <- subset(missing, date_glorysphys<as.POSIXct("2021-06-30"))
missing <- subset(missing, date_glorysphys<as.POSIXct("2021-06-30"))
View(o2_ak)
View(missing)
View(o2_ak)
View(missing)
View(o2_ak)
View(o2_ak)
View(o2_bc)
View(o2_wc)
View(ts_ak)
View(ts_bc)
View(ts_wc)
##Oxygen
#Clean up
o2_ak$date_gloryso2 <- as.character(o2_ak$date_gloryso2)
o2_ak$event_id <- o2_ak$hauljoin
o2_ak$hauljoin <- NULL
o2_wc <- o2_wc[,c(1:12,16:17,20,24:32)]
o2_bc <- o2_bc[,c(1:12, 16:17, 20, 24:31)]
#Combine
dat_o2 <- bind_rows(o2_ak, o2_bc, o2_wc)
#Clean more
dat_o2$year <- NULL
dat_o2$date_haul <- dat_o2$date2
dat_o2$date2 <- NULL
dat_o2$date <- NULL
dat_o2 <- as.data.frame(dat_o2)
saveRDS(dat, "glorys_combined.rds")
##Combine phys and oxygen data
dat <- mutate(dat_o2,dat_phys)
saveRDS(dat, "glorys_combined.rds")
#Set working directory
setwd("~/Dropbox/choke species/code/choke-species-data/code/wa_state")
### Set ggplot themes ###
theme_set(theme_bw(base_size = 35))
theme_update(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#Combined GlORYS data
dat <- readRDS("glorys_combined.rds")
#Label regions
dat$survey <- case_when(!is.na(dat$stlkey)~"IPHC",
grepl("SYN", dat$survey_name)~"BC",
grepl("NWFSC", dat$survey_name)|grepl("Triennial", dat$survey_name) ~"WC",
is.na(dat$stlkey)&is.na(dat$survey_name)~"AK")
###Distance of haul from GLORYS point
##Oxygen
test <- matrix(nrow=nrow(dat))
for(i in 1:nrow(dat)){
dist <- spDistsN1(as.matrix(dat[i,c("lon_start", "lat_start")]),as.matrix(dat[i,c("lon_gloryso2", "lat_gloryso2")]),longlat=FALSE)
test[i] <- dist
}
dat$dist_o2 <- test
##Temp-sal
test <- matrix(nrow=nrow(dat))
for(i in 1:nrow(dat)){
dist <- spDistsN1(as.matrix(dat[i,c("lon_start", "lat_start")]),as.matrix(dat[i,c("lon_glorysphys", "lat_glorysphys")]),longlat=FALSE)
test[i] <- dist
}
dat$dist_phys <- test
## Plot
ggplot(dat, aes(x=dist_o2))+geom_histogram()+xlab("Distance between haul and o2 GLORYS (km)")
ggplot(dat, aes(x=dist_phys))+geom_histogram()+xlab("Distance between haul and temp GLORYS (km)")
###Difference in depth between coordinates (root squared error)
#Get haul_depth column
#bottom_depth, depth_m, depth_IPHC
dat$depth_haul <- case_when(is.na(dat$depth_m) & is.na(dat$bottom_depth)~dat$depth_IPHC,
is.na(dat$depth_m) & is.na(dat$depth_IPHC)~dat$bottom_depth,
is.na(dat$bottom_depth) & is.na(dat$depth_IPHC)~dat$depth_m)
dat$depth_diffo2 <- sqrt((dat$depth_haul-dat$depth_gloryso2)^2)
dat$depth_diffts <- sqrt((dat$depth_haul-dat$depth_glorysphys)^2)
dat$depth_diffo2 <- dat$depth_haul-dat$depth_gloryso2
dat$depth_diffts <- dat$depth_haul-dat$depth_glorysphys
#Plot
ggplot(dat, aes(x=depth_diffo2))+geom_histogram()+xlab("Difference in reported haul depth and GLORYS depth o2 (m)")
ggplot(dat, aes(x=depth_diffts))+geom_histogram()+xlab("Difference in reported haul depth and GLORYS depth temp (m)")
ggplot(dat, aes(x=depth_diffts))+geom_histogram(aes(group=survey, fill=survey))+xlab("Difference in reported haul depth and GLORYS depth temp (m)")
ggplot(dat, aes(x=depth_diffo2))+geom_histogram(aes(group=survey, fill=survey))+xlab("Difference in reported haul depth and GLORYS depth o2 (m)")
ggplot(dat, aes(abs(x=depth_diffo2)))+geom_histogram(aes(group=survey, fill=survey), binwidth=10)+xlab("Difference in reported haul depth and GLORYS depth o2 (m)")
ggplot(dat, aes(x=depth_diffo2))+geom_histogram(aes(group=survey, fill=survey), binwidth=10)+xlab("Difference in reported haul depth and GLORYS depth o2 (m)")
View(o2_ak)
###Compare to in situ data
##Temperature
#Combine temperature
#In situ column names: gear_temperature, temp C, bottom_temp_c
dat$temp_haul<- case_when(is.na(dat$gear_temperature) & is.na(dat$'temp c')~dat$bottom_temp_c,
is.na(dat$gear_temperature) & is.na(dat$bottom_temp_c)~dat$'temp c',
is.na(dat$'temp c') & is.na(dat$bottom_temp_c)~dat$gear_temperature)
dat$temp_diff <- dat$temp_haul-dat$temp_glorys
ggplot(dat, aes(x=temp_diff))+geom_histogram()+xlab("Difference in reported haul temp and GLORYS temp (C)")
ggplot(dat, aes(abs(x=temp_diff)))+geom_histogram(aes(group=survey, fill=survey), binwidth=1)+xlab("Absolute difference in in situ temp and GLORYS temp (C)")
ggplot(dat, aes(x=temp_haul, y=temp_glorys))+geom_point(aes(group=survey, colour=survey))+xlab("Temp Haul")+ylab("Temp GLORYS")
#Salinity
dat$sal_diff <- dat$'salinity psu'-dat$sal_glorys
ggplot(dat, aes(x=sal_diff))+geom_histogram()+xlab("Difference in reported haul salinity and GLORYS sal (psu)")
ggplot(dat, aes(x=dat$'salinity psu', y=sal_glorys))+geom_point(aes(group=survey, colour=survey))+xlab("Sal Haul")+ylab("Sal GLORYS")
#Convert all oxygen to correct units
#GLORYS is in: o2 [mmol/m3], IPHC oxygen_ml is ml per L
SA = gsw_SA_from_SP(dat$'salinity psu', dat$depth_IPHC,dat$lon_start,dat$lat_start) #absolute salinity for pot T calc
pt = gsw_pt_from_t(SA,dat$'temp c',dat$depth_IPHC) #potential temp at a particular depth
CT = gsw_CT_from_t(SA,dat$'temp c',dat$depth_IPHC) #conservative temp
sigma0 = gsw_sigma0(SA,CT)
o2_umolkg = dat$oxygen_ml/(sigma0+1000)
dat$o2_IPHC <- o2_umolkg
dat$o2_diff <- dat$o2_IPHC-dat$o2_glorys
ggplot(dat, aes(x=o2_diff))+geom_histogram()+xlab("Difference in reported haul oxygen and GLORYS o2 (mmol kg-1)")
View(o2_bc)
View(ts_bc)
#Depth differences and sal differences
ggplot(dat, aes(x=depth_diffts,y=temp_diff))+geom_point(aes(group=survey, colour=survey))+xlab("Difference in haul depth and GLORYS temp depth (m)")+ylab("Difference in haul temp and GLORYS temp")
#Map points
ggplot(subset(dat, lon_start<0), aes(x=lon_start, y=lat_start))+geom_point(aes(group=survey, colour=survey), size=0.)+geom_point(mapping=aes(x=lon_glorysphys, y=lat_glorysphys), size=0.05)
#Larger distance
ggplot(subset(dat, lon_start< 122.5 & lon_start>-133 & lat_start>48&lat_start<54.75), aes(x=lon_start, y=lat_start))+geom_point(aes(group=survey, colour=survey), size=0.8)+geom_point(mapping=aes(x=lon_glorysphys, y=lat_glorysphys), size=1)
#Missing data
ggplot(subset(dat, is.na(dat$o2_glorys)|is.na(dat$temp_glorys)), aes(x=lon_start, y=lat_start))+geom_point(aes(group=survey, colour=survey), size=0.8)+geom_point(mapping=aes(x=lon_glorysphys, y=lat_glorysphys), size=1)
#Combine with ROMS data to get comparison
ROMS <- as.data.frame(readRDS("/Users/jindiv/Library/CloudStorage/Dropbox/choke species/code/choke-species-data/data/haul_combined_ROMS.rds"))
ROMS2 <- as.data.frame(ROMS[,c("event_id","lon", "lat", "depth", "o2_ROMS", "temp_ROMS", "sal_ROMS")])
ROMS2$event_id <- as.character(ROMS2$event_id)
ROMS2$o2_ROMS <- as.numeric(ROMS2$o2_ROMS)
ROMS2$temp_ROMS <- as.numeric(ROMS2$temp_ROMS)
ROMS2$sal_ROMS <- as.numeric(ROMS2$sal_ROMS)
dat$event_id <- as.character(dat$event_id)
dat2 <- filter(dat, event_id %in% ROMS2$event_id)
dat2 <- filter(dat2, !is.na(dat2$event_id))
dat2 <- left_join(ROMS2, dat2, by="event_id")
#Compare ROMS and GLORYS
#Difference in depth
dat2$depths <- dat2$depth-dat2$depth_gloryso2
#Difference in O2
dat2$diff_oxs <- dat2$o2_glorys-dat2$o2_ROMS
#Plot difference in depth
ggplot(dat2, aes(x=depths))+geom_histogram()+xlab("Difference in depth between ROMS and GLORYS")
#Plot distribution of oxygen over depth
ggplot(dat2, aes(y=-depth_haul, x=o2_ROMS))+geom_point(aes(group=survey, colour=survey))
ggplot(dat2, aes(y=-depth_haul, x=o2_glorys))+geom_point(aes(group=survey, colour=survey))
#Scatterplot of temp, sal, and O2 in GLORYS vs ROMS
ggplot(dat2, aes(x=temp_ROMS, y=temp_glorys))+geom_point(aes(group=survey, colour=survey))
View(ts_bc)
#Fix the few points where sal and temp got switched
ts_bc$temp_glorys <- case_when(temp_glorys>16 ~ sal_glorys,
temp_glorys<16~temp_glorys)
ts$bc$sal_glorys <- case_when(sal_glorys<28 ~ temp_glorys,
temp_glorys>28~sal_glorys)
#Fix the few points where sal and temp got switched
ts_bc$temp_glorys <- case_when(ts_bc$temp_glorys>16 ~ ts_bc$sal_glorys,
ts_bc$temp_glorys<16~ts_bc$temp_glorys)
ts$bc$sal_glorys <- case_when(ts_bc$sal_glorys<28 ~ ts_bc$temp_glorys,
ts_bc$temp_glorys>28~sal_glorys)
ts$bc$sal_glorys <- case_when(ts_bc$sal_glorys<28 ~ ts_bc$temp_glorys,
ts_bc$temp_glorys>28~ts_bc$sal_glorys)
ts$bc$sal_glorys <- case_when(ts_bc$sal_glorys<28 ~ ts_bc$temp_glorys,
ts_bc$sal_glorys>28 ~ ts_bc$sal_glorys)
ts_bc <- readRDS("~/Dropbox/choke species/code/choke-species-data/data/glorys/glorys_hauls/glorys_tempsal_BC.rds")
##Temp and sal
#Clean up
ts_ak$event_id <- ts_ak$hauljoin
ts_ak$date_glorysphys <- as.character(ts_ak$date_glorysphys)
ts_ak$hauljoin <- NULL
ts_wc <- ts_wc[,c(1:8,12:13,16,20:28)]
#Fix the few points where sal and temp got switched
ts_bc$temp_glorys <- case_when(ts_bc$temp_glorys>16 ~ ts_bc$sal_glorys,
ts_bc$temp_glorys<16~ts_bc$temp_glorys)
ts$bc$sal_glorys <- case_when(ts_bc$sal_glorys<28 ~ ts_bc$temp_glorys,
ts_bc$sal_glorys>28 ~ ts_bc$sal_glorys)
ts_bc$sal_glorys <- case_when(ts_bc$sal_glorys<28 ~ ts_bc$temp_glorys,
ts_bc$sal_glorys>28 ~ ts_bc$sal_glorys)
View(ts_bc)
#Combine
dat_phys <- bind_rows(ts_ak, ts_bc, ts_wc)
#Clean up more
dat_phys$year <- NULL
dat_phys$date_haul <- dat_phys$date2
dat_phys$date2 <- NULL
dat_phys$date <- NULL
dat_phys <- as.data.frame(dat_phys)
missing <- subset(dat_phys, is.na(dat_phys$temp_glorys))
missing <- subset(missing, date_glorysphys<as.POSIXct("2021-06-30"))
##Oxygen
#Clean up
o2_ak$date_gloryso2 <- as.character(o2_ak$date_gloryso2)
o2_ak$event_id <- o2_ak$hauljoin
o2_ak$hauljoin <- NULL
o2_wc <- o2_wc[,c(1:12,16:17,20,24:32)]
o2_bc <- o2_bc[,c(1:12, 16:17, 20, 24:31)]
#Combine
dat_o2 <- bind_rows(o2_ak, o2_bc, o2_wc)
#Load all glorys datasets
o2_ak <- readRDS("~/Dropbox/choke species/code/choke-species-data/data/glorys/glorys_hauls/glorys_o2_AKnew.rds")
View(o2_ak)
o2_bc <- readRDS("~/Dropbox/choke species/code/choke-species-data/data/glorys/glorys_hauls/glorys_o2_BC.rds")
o2_wc <- readRDS("~/Dropbox/choke species/code/choke-species-data/data/glorys/glorys_hauls/glorys_o2_WC.rds")
ts_ak <- readRDS("~/Dropbox/choke species/code/choke-species-data/data/glorys/glorys_hauls/glorys_tempsal_AKnew.rds")
ts_bc <- readRDS("~/Dropbox/choke species/code/choke-species-data/data/glorys/glorys_hauls/glorys_tempsal_BC.rds")
ts_wc <- readRDS("~/Dropbox/choke species/code/choke-species-data/data/glorys/glorys_hauls/glorys_tempsal_WC.rds")
#Add BC October data where missing
bc_oct_o2 <-  readRDS("~/Dropbox/choke species/code/choke-species-data/data/glorys/glorys_hauls/glorys_o2_bc3_full_region_bottom_octdates.rds")
bc_oct_ts <-  readRDS("~/Dropbox/choke species/code/choke-species-data/data/glorys/glorys_hauls/glorys_tempsal_bc3_full_region_bottom_octdates.rds")
##Temp and sal
#Clean up
ts_ak$event_id <- ts_ak$hauljoin
ts_ak$date_glorysphys <- as.character(ts_ak$date_glorysphys)
ts_ak$hauljoin <- NULL
ts_wc <- ts_wc[,c(1:8,12:13,16,20:28)]
ts_bc <- ts_bc[,c(1:8, 12:13, 16, 20:27)]
#Fix the few points where sal and temp got switched
ts_bc$temp_glorys <- case_when(ts_bc$temp_glorys>16 ~ ts_bc$sal_glorys,
ts_bc$temp_glorys<16~ts_bc$temp_glorys)
ts_bc$sal_glorys <- case_when(ts_bc$sal_glorys<28 ~ ts_bc$temp_glorys,
ts_bc$sal_glorys>28 ~ ts_bc$sal_glorys)
#Combine
dat_phys <- bind_rows(ts_ak, ts_bc, ts_wc)
#Clean up more
dat_phys$year <- NULL
dat_phys$date_haul <- dat_phys$date2
dat_phys$date2 <- NULL
dat_phys$date <- NULL
dat_phys <- as.data.frame(dat_phys)
missing <- subset(dat_phys, is.na(dat_phys$temp_glorys))
missing <- subset(missing, date_glorysphys<as.POSIXct("2021-06-30"))
##Oxygen
#Clean up
o2_ak$date_gloryso2 <- as.character(o2_ak$date_gloryso2)
o2_ak$event_id <- o2_ak$hauljoin
o2_ak$hauljoin <- NULL
o2_wc <- o2_wc[,c(1:12,16:17,20,24:32)]
o2_bc <- o2_bc[,c(1:12, 16:17, 20, 24:31)]
#Combine
dat_o2 <- bind_rows(o2_ak, o2_bc, o2_wc)
#Clean more
dat_o2$year <- NULL
dat_o2$date_haul <- dat_o2$date2
dat_o2$date2 <- NULL
dat_o2$date <- NULL
dat_o2 <- as.data.frame(dat_o2)
missing <- subset(dat, is.na(dat$o2_glorys))
missing <- missing[,c("lat_gloryso2", "lon_gloryso2", "date_gloryso2")]
missing <- unique(missing)
##Combine phys and oxygen data
dat <- mutate(dat_o2,dat_phys)
View(dat)
View(missing)
View(o2_ak)
##Combine phys and oxygen data
dat <- mutate(dat_o2,dat_phys)
saveRDS(dat, "glorys_combined.rds")
### Set ggplot themes ###
theme_set(theme_bw(base_size = 35))
theme_update(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
#Label regions
dat$survey <- case_when(!is.na(dat$stlkey)~"IPHC",
grepl("SYN", dat$survey_name)~"BC",
grepl("NWFSC", dat$survey_name)|grepl("Triennial", dat$survey_name) ~"WC",
is.na(dat$stlkey)&is.na(dat$survey_name)~"AK")
###Distance of haul from GLORYS point
##Oxygen
test <- matrix(nrow=nrow(dat))
for(i in 1:nrow(dat)){
dist <- spDistsN1(as.matrix(dat[i,c("lon_start", "lat_start")]),as.matrix(dat[i,c("lon_gloryso2", "lat_gloryso2")]),longlat=FALSE)
test[i] <- dist
}
dat$dist_o2 <- test
##Temp-sal
test <- matrix(nrow=nrow(dat))
for(i in 1:nrow(dat)){
dist <- spDistsN1(as.matrix(dat[i,c("lon_start", "lat_start")]),as.matrix(dat[i,c("lon_glorysphys", "lat_glorysphys")]),longlat=FALSE)
test[i] <- dist
}
View(ts_bc)
dat$dist_phys <- test
## Plot
ggplot(dat, aes(x=dist_o2))+geom_histogram()+xlab("Distance between haul and o2 GLORYS (km)")
ggplot(dat, aes(x=dist_phys))+geom_histogram()+xlab("Distance between haul and temp GLORYS (km)")
###Difference in depth between coordinates (root squared error)
#Get haul_depth column
#bottom_depth, depth_m, depth_IPHC
dat$depth_haul <- case_when(is.na(dat$depth_m) & is.na(dat$bottom_depth)~dat$depth_IPHC,
is.na(dat$depth_m) & is.na(dat$depth_IPHC)~dat$bottom_depth,
is.na(dat$bottom_depth) & is.na(dat$depth_IPHC)~dat$depth_m)
dat$depth_diffo2 <- sqrt((dat$depth_haul-dat$depth_gloryso2)^2)
dat$depth_diffts <- sqrt((dat$depth_haul-dat$depth_glorysphys)^2)
dat$depth_diffo2 <- dat$depth_haul-dat$depth_gloryso2
dat$depth_diffts <- dat$depth_haul-dat$depth_glorysphys
#Plot
ggplot(dat, aes(x=depth_diffo2))+geom_histogram()+xlab("Difference in reported haul depth and GLORYS depth o2 (m)")
ggplot(dat, aes(x=depth_diffts))+geom_histogram()+xlab("Difference in reported haul depth and GLORYS depth temp (m)")
ggplot(dat, aes(x=depth_diffts))+geom_histogram(aes(group=survey, fill=survey))+xlab("Difference in reported haul depth and GLORYS depth temp (m)")
ggplot(dat, aes(x=depth_diffo2))+geom_histogram(aes(group=survey, fill=survey))+xlab("Difference in reported haul depth and GLORYS depth o2 (m)")
ggplot(dat, aes(abs(x=depth_diffo2)))+geom_histogram(aes(group=survey, fill=survey), binwidth=10)+xlab("Difference in reported haul depth and GLORYS depth o2 (m)")
ggplot(dat, aes(x=depth_diffo2))+geom_histogram(aes(group=survey, fill=survey), binwidth=10)+xlab("Difference in reported haul depth and GLORYS depth o2 (m)")
###Compare to in situ data
##Temperature
#Combine temperature
#In situ column names: gear_temperature, temp C, bottom_temp_c
dat$temp_haul<- case_when(is.na(dat$gear_temperature) & is.na(dat$'temp c')~dat$bottom_temp_c,
is.na(dat$gear_temperature) & is.na(dat$bottom_temp_c)~dat$'temp c',
is.na(dat$'temp c') & is.na(dat$bottom_temp_c)~dat$gear_temperature)
dat$temp_diff <- dat$temp_haul-dat$temp_glorys
ggplot(dat, aes(x=temp_diff))+geom_histogram()+xlab("Difference in reported haul temp and GLORYS temp (C)")
ggplot(dat, aes(abs(x=temp_diff)))+geom_histogram(aes(group=survey, fill=survey), binwidth=1)+xlab("Absolute difference in in situ temp and GLORYS temp (C)")
ggplot(dat, aes(x=temp_haul, y=temp_glorys))+geom_point(aes(group=survey, colour=survey))+xlab("Temp Haul")+ylab("Temp GLORYS")
#Salinity
dat$sal_diff <- dat$'salinity psu'-dat$sal_glorys
ggplot(dat, aes(x=sal_diff))+geom_histogram()+xlab("Difference in reported haul salinity and GLORYS sal (psu)")
ggplot(dat, aes(x=dat$'salinity psu', y=sal_glorys))+geom_point(aes(group=survey, colour=survey))+xlab("Sal Haul")+ylab("Sal GLORYS")
View(dat)
#Load all glorys datasets
o2_ak <- readRDS("~/Dropbox/choke species/code/choke-species-data/data/glorys/glorys_hauls/glorys_o2_AKnew.rds")
o2_bc <- readRDS("~/Dropbox/choke species/code/choke-species-data/data/glorys/glorys_hauls/glorys_o2_BC.rds")
o2_wc <- readRDS("~/Dropbox/choke species/code/choke-species-data/data/glorys/glorys_hauls/glorys_o2_WC.rds")
ts_ak <- readRDS("~/Dropbox/choke species/code/choke-species-data/data/glorys/glorys_hauls/glorys_tempsal_AKnew.rds")
ts_bc <- readRDS("~/Dropbox/choke species/code/choke-species-data/data/glorys/glorys_hauls/glorys_tempsal_BC.rds")
ts_wc <- readRDS("~/Dropbox/choke species/code/choke-species-data/data/glorys/glorys_hauls/glorys_tempsal_WC.rds")
#Add BC October data where missing
bc_oct_o2 <-  readRDS("~/Dropbox/choke species/code/choke-species-data/data/glorys/glorys_hauls/glorys_o2_bc3_full_region_bottom_octdates.rds")
bc_oct_ts <-  readRDS("~/Dropbox/choke species/code/choke-species-data/data/glorys/glorys_hauls/glorys_tempsal_bc3_full_region_bottom_octdates.rds")
##Temp and sal
#Clean up
ts_ak$event_id <- ts_ak$hauljoin
ts_ak$date_glorysphys <- as.character(ts_ak$date_glorysphys)
ts_ak$hauljoin <- NULL
ts_wc <- ts_wc[,c(1:8,12:13,16,20:28)]
ts_bc <- ts_bc[,c(1:8, 12:13, 16, 20:27)]
#Fix the few points where sal and temp got switched
ts_bc$temp_glorys2 <- case_when(ts_bc$temp_glorys>16 ~ ts_bc$sal_glorys,
ts_bc$temp_glorys<16~ts_bc$temp_glorys)
ts_bc$sal_glorys2 <- case_when(ts_bc$sal_glorys<28 ~ ts_bc$temp_glorys,
ts_bc$sal_glorys>28 ~ ts_bc$sal_glorys)
View(ts_bc)
ts_bc$temp_glorys <- ts_bc$temp_glorys2
ts_bc$temp_glorys2 <- NULL
ts_bc$sal_glorys <- ts_bc$sal_glorys2
ts_bc$sal_glorys2 <- NULL
#Combine
dat_phys <- bind_rows(ts_ak, ts_bc, ts_wc)
#Clean up more
dat_phys$year <- NULL
dat_phys$date_haul <- dat_phys$date2
dat_phys$date2 <- NULL
dat_phys$date <- NULL
dat_phys <- as.data.frame(dat_phys)
missing <- subset(dat_phys, is.na(dat_phys$temp_glorys))
##Combine phys and oxygen data
dat <- mutate(dat_o2,dat_phys)
#Label regions
dat$survey <- case_when(!is.na(dat$stlkey)~"IPHC",
grepl("SYN", dat$survey_name)~"BC",
grepl("NWFSC", dat$survey_name)|grepl("Triennial", dat$survey_name) ~"WC",
is.na(dat$stlkey)&is.na(dat$survey_name)~"AK")
###Distance of haul from GLORYS point
##Oxygen
test <- matrix(nrow=nrow(dat))
for(i in 1:nrow(dat)){
dist <- spDistsN1(as.matrix(dat[i,c("lon_start", "lat_start")]),as.matrix(dat[i,c("lon_gloryso2", "lat_gloryso2")]),longlat=FALSE)
test[i] <- dist
}
dat$dist_o2 <- test
##Temp-sal
test <- matrix(nrow=nrow(dat))
for(i in 1:nrow(dat)){
dist <- spDistsN1(as.matrix(dat[i,c("lon_start", "lat_start")]),as.matrix(dat[i,c("lon_glorysphys", "lat_glorysphys")]),longlat=FALSE)
test[i] <- dist
}
dat$dist_phys <- test
## Plot
ggplot(dat, aes(x=dist_o2))+geom_histogram()+xlab("Distance between haul and o2 GLORYS (km)")
ggplot(dat, aes(x=dist_phys))+geom_histogram()+xlab("Distance between haul and temp GLORYS (km)")
###Difference in depth between coordinates (root squared error)
#Get haul_depth column
#bottom_depth, depth_m, depth_IPHC
dat$depth_haul <- case_when(is.na(dat$depth_m) & is.na(dat$bottom_depth)~dat$depth_IPHC,
is.na(dat$depth_m) & is.na(dat$depth_IPHC)~dat$bottom_depth,
is.na(dat$bottom_depth) & is.na(dat$depth_IPHC)~dat$depth_m)
dat$depth_diffo2 <- sqrt((dat$depth_haul-dat$depth_gloryso2)^2)
dat$depth_diffts <- sqrt((dat$depth_haul-dat$depth_glorysphys)^2)
dat$depth_diffo2 <- dat$depth_haul-dat$depth_gloryso2
dat$depth_diffts <- dat$depth_haul-dat$depth_glorysphys
#Plot
ggplot(dat, aes(x=depth_diffo2))+geom_histogram()+xlab("Difference in reported haul depth and GLORYS depth o2 (m)")
ggplot(dat, aes(x=depth_diffts))+geom_histogram()+xlab("Difference in reported haul depth and GLORYS depth temp (m)")
ggplot(dat, aes(x=depth_diffts))+geom_histogram(aes(group=survey, fill=survey))+xlab("Difference in reported haul depth and GLORYS depth temp (m)")
ggplot(dat, aes(x=depth_diffo2))+geom_histogram(aes(group=survey, fill=survey))+xlab("Difference in reported haul depth and GLORYS depth o2 (m)")
ggplot(dat, aes(abs(x=depth_diffo2)))+geom_histogram(aes(group=survey, fill=survey), binwidth=10)+xlab("Difference in reported haul depth and GLORYS depth o2 (m)")
ggplot(dat, aes(x=depth_diffo2))+geom_histogram(aes(group=survey, fill=survey), binwidth=10)+xlab("Difference in reported haul depth and GLORYS depth o2 (m)")
###Compare to in situ data
##Temperature
#Combine temperature
#In situ column names: gear_temperature, temp C, bottom_temp_c
dat$temp_haul<- case_when(is.na(dat$gear_temperature) & is.na(dat$'temp c')~dat$bottom_temp_c,
is.na(dat$gear_temperature) & is.na(dat$bottom_temp_c)~dat$'temp c',
is.na(dat$'temp c') & is.na(dat$bottom_temp_c)~dat$gear_temperature)
dat$temp_diff <- dat$temp_haul-dat$temp_glorys
ggplot(dat, aes(x=temp_diff))+geom_histogram()+xlab("Difference in reported haul temp and GLORYS temp (C)")
ggplot(dat, aes(abs(x=temp_diff)))+geom_histogram(aes(group=survey, fill=survey), binwidth=1)+xlab("Absolute difference in in situ temp and GLORYS temp (C)")
ggplot(dat, aes(x=temp_haul, y=temp_glorys))+geom_point(aes(group=survey, colour=survey))+xlab("Temp Haul")+ylab("Temp GLORYS")
#Salinity
dat$sal_diff <- dat$'salinity psu'-dat$sal_glorys
ggplot(dat, aes(x=sal_diff))+geom_histogram()+xlab("Difference in reported haul salinity and GLORYS sal (psu)")
ggplot(dat, aes(x=dat$'salinity psu', y=sal_glorys))+geom_point(aes(group=survey, colour=survey))+xlab("Sal Haul")+ylab("Sal GLORYS")
#Convert all oxygen to correct units
#GLORYS is in: o2 [mmol/m3], IPHC oxygen_ml is ml per L
SA = gsw_SA_from_SP(dat$'salinity psu', dat$depth_IPHC,dat$lon_start,dat$lat_start) #absolute salinity for pot T calc
pt = gsw_pt_from_t(SA,dat$'temp c',dat$depth_IPHC) #potential temp at a particular depth
CT = gsw_CT_from_t(SA,dat$'temp c',dat$depth_IPHC) #conservative temp
sigma0 = gsw_sigma0(SA,CT)
o2_umolkg = dat$oxygen_ml/(sigma0+1000)
dat$o2_IPHC <- o2_umolkg
dat$o2_diff <- dat$o2_IPHC-dat$o2_glorys
ggplot(dat, aes(x=o2_diff))+geom_histogram()+xlab("Difference in reported haul oxygen and GLORYS o2 (mmol kg-1)")
#Depth differences and sal differences
ggplot(dat, aes(x=depth_diffts,y=temp_diff))+geom_point(aes(group=survey, colour=survey))+xlab("Difference in haul depth and GLORYS temp depth (m)")+ylab("Difference in haul temp and GLORYS temp")
#Map points
ggplot(subset(dat, lon_start<0), aes(x=lon_start, y=lat_start))+geom_point(aes(group=survey, colour=survey), size=0.)+geom_point(mapping=aes(x=lon_glorysphys, y=lat_glorysphys), size=0.05)
#Larger distance
ggplot(subset(dat, lon_start< 122.5 & lon_start>-133 & lat_start>48&lat_start<54.75), aes(x=lon_start, y=lat_start))+geom_point(aes(group=survey, colour=survey), size=0.8)+geom_point(mapping=aes(x=lon_glorysphys, y=lat_glorysphys), size=1)
ggplot(subset(dat, dist_phys>1 | dist_o2 >1), aes(x=lon_start, y=lat_start))+geom_point(aes(group=survey, colour=survey), size=0.8)+geom_point(mapping=aes(x=lon_glorysphys, y=lat_glorysphys), size=1)
#Missing data
ggplot(subset(dat, is.na(dat$o2_glorys)|is.na(dat$temp_glorys)), aes(x=lon_start, y=lat_start))+geom_point(aes(group=survey, colour=survey), size=0.8)+geom_point(mapping=aes(x=lon_glorysphys, y=lat_glorysphys), size=1)
#Combine with ROMS data to get comparison
ROMS <- as.data.frame(readRDS("/Users/jindiv/Library/CloudStorage/Dropbox/choke species/code/choke-species-data/data/haul_combined_ROMS.rds"))
ROMS2 <- as.data.frame(ROMS[,c("event_id","lon", "lat", "depth", "o2_ROMS", "temp_ROMS", "sal_ROMS")])
ROMS2$event_id <- as.character(ROMS2$event_id)
ROMS2$o2_ROMS <- as.numeric(ROMS2$o2_ROMS)
ROMS2$temp_ROMS <- as.numeric(ROMS2$temp_ROMS)
ROMS2$sal_ROMS <- as.numeric(ROMS2$sal_ROMS)
dat$event_id <- as.character(dat$event_id)
dat2 <- filter(dat, event_id %in% ROMS2$event_id)
dat2 <- filter(dat2, !is.na(dat2$event_id))
dat2 <- left_join(ROMS2, dat2, by="event_id")
#Compare ROMS and GLORYS
#Difference in depth
dat2$depths <- dat2$depth-dat2$depth_gloryso2
#Difference in O2
dat2$diff_oxs <- dat2$o2_glorys-dat2$o2_ROMS
#Plot difference in depth
ggplot(dat2, aes(x=depths))+geom_histogram()+xlab("Difference in depth between ROMS and GLORYS")
#Plot distribution of oxygen over depth
ggplot(dat2, aes(y=-depth_haul, x=o2_ROMS))+geom_point(aes(group=survey, colour=survey))
ggplot(dat2, aes(y=-depth_haul, x=o2_glorys))+geom_point(aes(group=survey, colour=survey))
#Scatterplot of temp, sal, and O2 in GLORYS vs ROMS
ggplot(dat2, aes(x=temp_ROMS, y=temp_glorys))+geom_point(aes(group=survey, colour=survey))
ggplot(dat2, aes(x=sal_ROMS, y=sal_glorys))+geom_point(aes(group=survey, colour=survey))
ggplot(dat2, aes(x=o2_ROMS, y=o2_glorys))+geom_point(aes(group=survey, colour=survey))
#Plot difference in oxygen over depth
ggplot(dat2,aes(x=depth_haul, y=diff_oxs))+geom_point(aes(group=survey, colour=survey))+xlab("Depth of haul")+ylab("Difference in GLORYS and ROMS oxygen")
View(missing)
###Evaluate for the data far from point
far <- subset(dat, dist_o2>1.5 | dist_phys >1.5)
View(far)
##Evaluate for missing data
missing <- subset(dat, is.na(dat$o2_glorys)|is.na(dat$temp_glorys))
View(missing)
##Evaluate for missing data
missing <- subset(dat, is.na(dat$o2_glorys))
View(missing)
saveRDS(missing, file="missing_o2.rds")
missing_o2 <- subset(missing, is.na(missing$o2_glorys))
missing_o2 <- missing_o2[,c("lat_gloryso2", "lon_gloryso2", "date_gloryso2")]
saveRDS(missing_o2, file="missing_o2_glorys_data.rds")
missing_ts <- subset(missing, is.na(missing$temp_glorys))
missing_ts <- missing_ts[,c("lat_glorysphys", "lon_glorysphys", "date_glorysphys")]
View(missing_ts)
missing_ts <- subset(missing, is.na(missing$temp_glorys))
View(missing)
missing <- subset(dat, is.na(dat$temp_glorys))
View(missing)
saveRDS(missing_ts, file="missing_ts_glorys_data.rds")
View(missing_ts)
View(missing_ts)
missing <- subset(dat, is.na(dat$temp_glorys))
View(missing)
View(dat)
gc()
